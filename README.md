## COPYRIGHT

   Copyright (C) 2012 Feuerlabs, Inc. All rights reserved.

   This Source Code Form is subject to the terms of the Mozilla Public
   License, v. 2.0. If a copy of the MPL was not distributed with this
   file, You can obtain one at http://mozilla.org/MPL/2.0/.


# Exodev build system
This directory contains a template application and build system
to create exodev-based applications to be deployed on target embedded
systems.

The build system does the following:
- Downloads OTP R15B and does a cross compile for the target architecture

  This OTP is not the one deployed as a runtime system on the target,
  that is done by TPLINO.  Instead, this cross build will be used when
  port drivers and other erlang-dependent binaries are built. Include
  files and libraries will be retrieved from the cross build and
  linked into the binaries and .so files that are to execute on the
  target architecture.

  See bottom part of Makefile for details on how the downloading and
  compiling is carried out

- Retrieves and builds the exodev core applications
  rebar.config contains a dependency on exodev. Once exodev has been
  checked out to deps/ using rebar get-deps, exodev's own rebar.config
  dependencies will check out all modules that are a part of the exodev
  stack. Any additional dependencies can be added directly to
  rebar.config in the same directory as this file.

- Builds local or cross-compiled versions of the software
  The build system will setup toolchains and compiler directives
  so that the application and all the exosense modules are
  compiled either for the build machine or the target architecture

- Build release
  The release contains all exodev core applications, any customer-specified
  applications, and any port drivers included in these lists.

The build system does **not** do the following:
- Build a linux distro for the target
  This is done by TPLINO

- Build an erlang distro for the target
  This is done by TPLINO

# The exodev_build.config file
The rebar.config file at the root is extended by exodev_build.config,
which contains information about the target architecture, toolchains,
kernel header paths and other necessities. This file is parsed by
the local ./get_build_config_val escript, which in its turn is invoked
by the Makefile to set its variables.


# How to build your own application
- Fork and exteend this template project
  The fork will be the basis for your application. Add the source files
  and any port drivers necessary to build and run the application.

- Add any additional dependencies to rebar.config
  rebar.config, as stored in the template project, only contains an
  exodev dependency. The exodev module, in its turn, will check out all
  core modules necessary to build the exodev stack either for the local machine
  or the target architecture.

  You can add additional dependencies in the rebar.config file residing
  in the same directory as this README file.

- Specify a release name: release_name
  This name will be used as a nodeid when the build system executes
  rebar create-node.

- Specify the tool chain root: x_comp_toolchain_root
  The x_comp_toolchain_root should be set to the top level directory where
  the gnu cross compile toolchain resides on the build machine.

- Specify the linux header file path: x_comp_kernel_headers
  This entry should point to the directory where the header files
  for the kernel running on the target machine are stored. The header
  files should be generated by a "make headers_install" executed
  in the root of the kernel source tree. If the correct kernel header
  files are searched by default by the toolchain, you can set the
  x_comp_kernel_headers entry to ".".

- Specify the target architecture: x_comp_target_arch
  The x_comp_target_arch should be set to the architecture
  that both the cross compiled OTP and any port drivers should target.

  Please note that the build tools in the cross compile toolchain
  will be prefixed with this value.

  If x_comp_target_arch is set to

      arm-none-linux-gnueabi

  and x_comp_toolchain_root is set to:

      /opt/arm-2007q1

  then gcc, for example, will be invoked as:

      /opt/arm-2007q1/bin/arm-none-linux-gnueabi

  the value of x_comp_target_arch will also be used when the cross compiled OTP
  is locally installed under the exodev top directory. Using the example above,
  the OTP will be installed as:

      ./erl-arm-none-linux-gnueabi

- [Optional]  Specify the build box architecture: x_comp_build_arch
  This target does normally not have to be changed from its default
  i686-pc-linux-gnu value. If you are uncertain about which value to
  set this to, check what the OTP source tree's
  erts/autoconf/config.guess shell script outputs when executed.

- [Optional] Specify the download URL for Erlang OTP: x_comp_otp_download_url
  The default value points to the official erlang.org location and
  should not have to be changed. Please note that the actual
  file to be downloaded is not given, just the directory.

- [Optional] Specify the OTP file to download: x_comp_otp_download_file
  The default value points to the latest official release, R15B as
  of this writing, and should not have to be changed. Older versions
  than R15B are not guaranteed to work.

- [Optional] Specify additional c compiler flags for port drivers: x_comp_c_flags
  The flags specified here will be passed to gcc when compiling any port drivers
  in the combined apps and deps list of exodev_build.config and rebar.config


- [Optional] Specify additional linkerflags for port drivers: x_comp_ld_flags
  The flags specified here will be passed to gcc when linking any port drivers
  in the combined apps and deps list of exodev_build.config and rebar.config

- Build the OTP

      make otp

  The OTP will be downloaded, unpacked, cross compiled, and installed
  in erl-${x_comp_target_arch}.

- Build the core system and your app

      make

  This simply invokes the compile target, which does the following:

     rebar get-deps
     rebar compile

  **NOTE:** Do **not** run rebar get-deps directly. If you have to do it,
  you must inhibit rebar get-deps from recursively checking out additional
  dependencies by calling it like this:

     EXODEV_COMP=1 rebar get-deps

  The EXODEV_COMP variable will be checked by rebar.config.script files
  of the core exodev modules. If the variable is set, the script files
  will skip any local dependencies in order to avoid recursion.

  This is done to avoid multiple version dependencies of a single module and
  to get a single place, exodev/rebar.config, where all dependencies are
  listed for the entire system (apart from the rebar.config file in the
  top application project).

  The compilation is done with the build system as the target, thus
  letting you test your code on the build box (or any other dev box).

  **NOTE:** When cross-compiling, make sure that you don't have any of
  the modules in ./deps also present in the parent directory of this
  project. In that case, the parent directory's project will be used
  by make target-generate and you will have .so files compiled for
  the build system in your rel/[release] directory.

  **NOTE:** When running the app, either on the target system or on the
  build box, make sure that you do it using the following command:

      cd rel/$(RELEASE_NAME)
      LD_LIBRARY_PATH=./lib/netlink-1/priv ./bin/$(RELEASE_NAME) start

  The netlink module is dynamically linked cross compiled libnl
  libraries stored in lib/netlink-1/priv. These cannot be found by the
  erlang runtime unless LD_LIBRARY_PATH is setup correctly.  If you
  have a fix for this, please mail me at magnus@feuerlabs.com.


- Test locally **ULF PLEASE RUN THROUGH THE CASE**

- Create a release
      make clean
      make target-compile
      make release [RELNAME=<name>]
      make target-generate

  If RELNAME is omitted, the release node will be named "exodev"
  target-compile will compile for the target specified in x_comp_target_arch
  in the exodev_build,config file.


- **ULF PLEASE CONTINUE HERE WITH RELEASE AND GENERATE**

# Compiling Port Drivers

